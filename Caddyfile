# /Caddyfile
{
    log {
        # Log to stderr so it appears in Railway logs
        output stderr
        # Use JSON format for clarity, include the variable value
        format json {
            time_format rfc3339
            # Add a custom field 'private_host_var' using the placeholder
            field private_host_var "{env.JUPYTER_IPFS_PRIVATE_HOST}"
            # Add other useful fields
            field level "{log.level}"
            field ts "{log.time}"
            field msg "{log.msg}"
            field request "{log.request>method} {log.request>uri}"
            field status "{log.response>status}"
            field size "{log.response>size}"
            field duration "{log.duration}"
            field remote_ip "{log.request>remote_ip}"
            field proto "{log.request>proto}"
        }
        level INFO # Or DEBUG for more verbosity
    }
}

# Define the main site block listening on the port Railway provides ($PORT)
http://:{$PORT} {
	# Reverse proxy all requests to the internal jupyter-ipfs service.
	# Use the environment variable injected by Railway.
	# Port 4001 is the internal IPFS WS port.
	# --- MODIFIED LINE: Removed http:// ---
	reverse_proxy {env.JUPYTER_IPFS_PRIVATE_HOST}:4001
	# --- END MODIFIED LINE ---
}
